"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const node_fetch_1=__importDefault(require("node-fetch")),Constants_1=require("../Constants"),Utils_1=require("../Utils"),Post_1=__importDefault(require("../structures/Post")),SearchResults_1=__importDefault(require("../structures/SearchResults"));class Booru{constructor(t,e=null){const s=Utils_1.resolveSite(t.domain);if(null===s)throw new Error(`Invalid site passed: ${t}`);this.domain=s,this.site=t,this.credentials=e}async search(t,{limit:e=1,random:s=!1,page:r=0}={}){const o=s&&!this.site.random?100:0;try{const i=await this.doSearchRequest(t,{limit:e,random:s,page:r});return this.parseSearchResult(i,{fakeLimit:o,tags:t,limit:e,random:s,page:r})}catch(t){throw new Constants_1.BooruError(t.message)}}postView(t){if("string"==typeof t&&Number.isNaN(parseInt(t,10)))throw new Constants_1.BooruError(`Not a valid id for postView: ${t}`);return`http${this.site.insecure?"":"s"}://${this.domain}${this.site.api.postView}${t}`}async doSearchRequest(t,{uri:e=null,limit:s=1,random:r=!1,page:o=0}={}){let i;Array.isArray(t)||(t=[t]),r&&(this.site.random?t.push("order:random"):i=100);const a=e||Constants_1.searchURI(this.site,t,i||s,o),n=Constants_1.defaultOptions,u="xml"===this.site.type;try{const t=await node_fetch_1.default(a,n),e=u?await t.text():await t.json(),s=u?await Utils_1.jsonfy(e):e;if(t.ok)return s;throw new Constants_1.BooruError(`Received HTTP ${t.status} `+`from booru: '${s.error||s.message||JSON.stringify(s)}'`)}catch(t){if("invalid-json"===t.type)return"";throw t}}parseSearchResult(t,{fakeLimit:e,tags:s,limit:r,random:o,page:i}){if(!1===t.success)throw new Constants_1.BooruError(t.message||t.reason);let a;""===t?a=[]:e?a=Utils_1.shuffle(t):t.constructor===Object&&(a=[t]);const n=(a||t).slice(0,r).map(t=>new Post_1.default(t,this)),u={limit:r,random:o,page:i};return void 0===s&&(s=[]),Array.isArray(s)||(s=[s]),new SearchResults_1.default(n,s,u,this)}}exports.Booru=Booru,exports.default=Booru;